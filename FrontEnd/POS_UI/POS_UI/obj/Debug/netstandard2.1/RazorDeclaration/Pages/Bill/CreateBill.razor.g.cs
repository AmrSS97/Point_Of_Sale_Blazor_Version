// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace POS_UI.Pages.Bill
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\_Imports.razor"
using System.Net.Http.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\_Imports.razor"
using Microsoft.AspNetCore.Components.WebAssembly.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\_Imports.razor"
using POS_UI;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\_Imports.razor"
using POS_UI.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\Pages\Bill\CreateBill.razor"
using Models;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/createbill")]
    public partial class CreateBill : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 107 "C:\Users\AmrSherief\Desktop\PointOfSale\Project\FrontEnd\POS_UI\POS_UI\Pages\Bill\CreateBill.razor"
       
    private List<Product> Products = new List<Product>();
    private List<Discount> Discounts = new List<Discount>();
    private List<Customer> Customers = new List<Customer>();
    private Bill Bill = new Bill();
    private double TotalAmount = 0;
    private double TotalDiscount = 0;
    private bool IsValid;
    protected override async Task OnInitializedAsync()
    {
        Bill.ItemDtoList = new List<Item>();
        Products = await Http.GetFromJsonAsync<List<Product>>("http://localhost:5000/api/Product");
        Customers = await Http.GetFromJsonAsync<List<Customer>>("http://localhost:5000/api/Customer");
    }
    private async Task AddToItemList(Product Product)
    {
        Item CheckItem = Bill.ItemDtoList.Where(i => i.ProductName == Product.ProductName).FirstOrDefault();
        if (CheckItem == null)
        {
            Item Item = new Item();
            Item.ProductName = Product.ProductName;
            Item.ItemQuantity = 1;
            await DecrementProductStock(Item);
            if (IsValid)
            {
                Discount Discount = new Discount();
                Bill.ItemDtoList.Add(Item);
                Discount.ProductName = Item.ProductName;
                Discount.DiscountAmount = Product.Price * Product.DiscountPercentage * 0.01;
                Discounts.Add(Discount);
                TotalAmount += Products.Where(p => p.ProductName == Item.ProductName).FirstOrDefault().Price;

            }
        }
        else
        {
            await DecrementProductStock(CheckItem);
            if (IsValid)
            {
                Bill.ItemDtoList.Where(i => i.ProductName == Product.ProductName).FirstOrDefault().ItemQuantity++;
                TotalAmount += Products.Where(p => p.ProductName == CheckItem.ProductName).FirstOrDefault().Price;
                Discounts.Where(d => d.ProductName == Product.ProductName).FirstOrDefault().DiscountAmount *= 2;
            }
        }
    }
    private async Task IncrementItemQuantity(Item Item)
    {
        await DecrementProductStock(Item);
        if (IsValid)
        {
            Bill.ItemDtoList.Where(i => i.ProductName == Item.ProductName).FirstOrDefault().ItemQuantity++;
            TotalAmount += Products.Where(p => p.ProductName == Item.ProductName).FirstOrDefault().Price;
            Discounts.Where(d => d.ProductName == Item.ProductName).FirstOrDefault().DiscountAmount *= 2;
        }
    }
    private void DecrementItemQuantity(Item Item)
    {
        int value = --Bill.ItemDtoList.Where(i => i.ProductName == Item.ProductName).FirstOrDefault().ItemQuantity;
        TotalAmount -= Products.Where(p => p.ProductName == Item.ProductName).FirstOrDefault().Price;
        IncrementProductStock(Item);
        if (value < 1)
        {
            Bill.ItemDtoList.Remove(Item);
            Discount Discount = Discounts.Where(d => d.ProductName == Item.ProductName).FirstOrDefault();
            Discounts.Remove(Discount);
        }
        else
        {
            Discounts.Where(d => d.ProductName == Item.ProductName).FirstOrDefault().DiscountAmount /= 2;
        }
    }
    private void IncrementProductStock(Item Item)
    {
        Products.Where(p => p.ProductName == Item.ProductName).FirstOrDefault().Stock++;
    }
    private async Task DecrementProductStock(Item Item)
    {
        int StockValue = Products.Where(p => p.ProductName == Item.ProductName).FirstOrDefault().Stock;
        if (StockValue > 0)
        {
            Products.Where(p => p.ProductName == Item.ProductName).FirstOrDefault().Stock--;
            IsValid = true;
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Product Out Of Stock !");
            IsValid = false;
        }
    }
    private double GetAmountDue()
    {
        TotalDiscount = 0;
        foreach (var Discount in Discounts)
        {
            TotalDiscount += Discount.DiscountAmount;
        }
        return TotalAmount - TotalDiscount;
    }

    private async Task PostBill()
    {
        Bill.TotalValue = GetAmountDue();
        Bill.UserName = "admin";
        Bill.CustomerPhone = Customers.Where(c => c.FullName == Bill.CustomerName).FirstOrDefault().CustomerPhone;
        Bill.BillDate = DateTime.Now;
        await Http.PostAsJsonAsync<Bill>("http://localhost:5000/api/Bill", Bill);
        NavManager.NavigateTo("/");
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager NavManager { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JSRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private HttpClient Http { get; set; }
    }
}
#pragma warning restore 1591
